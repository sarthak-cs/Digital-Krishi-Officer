<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>ğŸŒ¾ Digital Krishi Officer ğŸŒ¾</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f2f7f5;
      color: #333;
    }



    .header {
      background-image: url('farm.jpg');
      background-size: auto;
      background-position: -2rem 35rem;
      padding: 2rem;
      color: black;
      margin-left:1rem ;
      margin-right: 1rem;
      text-align: center;
    }

    .container {
      padding: 1rem 2rem;
    }

    .section {
      background: white;
      border-radius: 10px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    h2 {
      color: #2e8b57;
    }

    .forecast-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 1rem;
    }

    .forecast-card {
      background: #e6f3ea;
      padding: 0.8rem;
      border-radius: 8px;
      text-align: center;
      font-size: 0.9rem;
    }

    .loader {
      color: #2e8b57;
      margin-top: 1rem;
    }

    textarea,
    input[type="file"] {
      width: 100%;
      margin: 0.5rem 0;
      padding: 0.6rem;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    button {
      background: #2e8b57;
      color: white;
      padding: 0.8rem 1.2rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 0.5rem;
      font-size: 2rem;
    }

    button:hover {
      background: #246e45;
    }

    select {
      width: 100%;
      padding: 0.8rem;
      font-size: 1.1rem;
      margin-bottom: 1.5rem;
    }

    img.preview {
      max-width: 100%;
      margin-top: 0.5rem;
      border-radius: 6px;
    }
  </style>
</head>

<body>
  <header class="header">
    <h1>ğŸŒ¾ Digital Krishi Officer ğŸŒ¾</h1>
  </header>

  <div class="container">

    <div class="section">
      <h2>Select Language</h2>
      <select id="global-language" onchange="updateInterfaceLanguage()">
        <option value="en">English</option>
        <option value="hi">à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
        <option value="ml">à´®à´²à´¯à´¾à´³à´‚</option>
        <option value="ta">à®¤à®®à®¿à®´à¯</option>
        <option value="kn">à²•à²¨à³à²¨à²¡</option>
      </select>


    </div>


    <div class="section">
      <h2 id="ask-title">â“ Ask a Farming Question</h2>
      <button onclick="recordVoice()">ğŸ™ï¸ Ask with Voice</button>
      <textarea id="text-query" rows="5" placeholder="Type your farming question here..."></textarea>
      <button onclick="askQuestion()">Submit Query</button>
      <div id="text-answer" class="loader"></div>
    </div>

    <!-- ğŸŒ¿ IMAGE ANALYSIS SECTION -->
    <div class="section">
      <h2 id="image-title">ğŸŒ¿ Upload Plant Image</h2>
      <input type="file" id="plant-image" accept="image/*">
      <img id="preview" class="preview" style="display:none;">
      <button onclick="identifyPlant()">Analyze Plant with photograph</button>
      <div id="img-answer" class="loader"></div>
    </div>
  </div>


  <div class="section">
    <h2 id="weather-title">ğŸ“ Local Weather (Auto-Detected)</h2>
    <div id="weather-output"></div>
    <div class="loader" id="weather-loader">Detecting your location and fetching weather...</div>
  </div>

  <div class="section">
    <h2>ğŸ’¹ Crop Market Price</h2>

    <input type="text" id="crop-name" placeholder="Enter crop name (e.g., Tomato)"
      style="width: 90%; padding: 0.8rem; margin-bottom: 1rem;">
    <input type="text" id="state-name" placeholder="Enter state name (e.g., Andhra Pradesh)"
      style="width: 90%; padding: 0.8rem; margin-bottom: 1rem;">
<br>
    <button onclick="getCropPrice()">Get Price</button>
    <div id="market-price-output" class="loader">Enter a crop name and state to get price info</div>
  </div>

  <div class="section">
    <h2>ğŸ“œ Government Schemes</h2>
    <button onclick="getGovernmentSchemes()" style="padding: 1rem; font-size: 1.2rem;">Load Government Schemes</button>
    <div id="schemes-output" class="loader">Click the button to load schemes</div>
  </div>
  <footer style="background-color: green; text-align: center; padding: 1rem; color: white; font-size: 0.9rem;">
    Thanks for visiting
  </footer>
  <script>
    let selectedLanguage = 'en';

    function updateInterfaceLanguage() {
      selectedLanguage = document.getElementById('global-language').value;

      const titles = {
        en: { weather: 'ğŸ“ Local Weather (Auto-Detected)', ask: 'â“ Ask a Farming Question', image: 'ğŸŒ¿ Upload Plant Image' },
        hi: { weather: 'ğŸ“ à¤¸à¥à¤¥à¤¾à¤¨à¥€à¤¯ à¤®à¥Œà¤¸à¤® (à¤¸à¥à¤µà¤šà¤¾à¤²à¤¿à¤¤ à¤ªà¤¤à¤¾)', ask: 'â“ à¤–à¥‡à¤¤à¥€ à¤¸à¥‡ à¤¸à¤‚à¤¬à¤‚à¤§à¤¿à¤¤ à¤¸à¤µà¤¾à¤² à¤ªà¥‚à¤›à¥‡à¤‚', image: 'ğŸŒ¿ à¤ªà¥Œà¤§à¥‡ à¤•à¥€ à¤›à¤µà¤¿ à¤…à¤ªà¤²à¥‹à¤¡ à¤•à¤°à¥‡à¤‚' },
        ml: { weather: 'ğŸ“ à´ªàµà´°à´¾à´¦àµ‡à´¶à´¿à´• à´•à´¾à´²à´¾à´µà´¸àµà´¥ (à´¸àµà´µà´¯à´‚ à´•à´£àµà´Ÿàµ†à´¤àµà´¤à´¿à´¯)', ask: 'â“ à´•àµ¼à´·à´• à´šàµ‹à´¦àµà´¯à´™àµà´™àµ¾ à´šàµ‹à´¦à´¿à´•àµà´•àµà´•', image: 'ğŸŒ¿ à´¸à´¸àµà´¯à´¤àµà´¤à´¿à´¨àµà´±àµ† à´šà´¿à´¤àµà´°à´‚ à´…à´ªàµâ€Œà´²àµ‹à´¡àµ à´šàµ†à´¯àµà´¯àµà´•' },
        ta: { weather: 'ğŸ“ à®‰à®³à¯à®³à¯‚à®°à¯ à®µà®¾à®©à®¿à®²à¯ˆ (à®¤à®¾à®©à®¾à®• à®•à®£à¯à®Ÿà®±à®¿à®¤à®²à¯)', ask: 'â“ à®µà¯‡à®³à®¾à®£à¯à®®à¯ˆ à®•à¯‡à®³à¯à®µà®¿à®•à®³à¯ˆ à®•à¯‡à®³à¯à®™à¯à®•à®³à¯', image: 'ğŸŒ¿ à®¤à®¾à®µà®° à®ªà®Ÿà®¤à¯à®¤à¯ˆ à®ªà®¤à®¿à®µà¯‡à®±à¯à®±à¯à®•' },
        kn: { weather: 'ğŸ“ à²¸à³à²¥à²³à³€à²¯ à²¹à²µà²¾à²®à²¾à²¨ (à²¸à³à²µà²¯à²‚à²šà²¾à²²à²¿à²¤ à²ªà²¤à³à²¤à³†)', ask: 'â“ à²•à³ƒà²·à²¿ à²ªà³à²°à²¶à³à²¨à³† à²•à³‡à²³à²¿', image: 'ğŸŒ¿ à²¸à²¸à³à²¯à²¦ à²šà²¿à²¤à³à²° à²…à²ªà³à²²à³‹à²¡à³ à²®à²¾à²¡à²¿' }
      };

      document.getElementById('weather-title').innerText = titles[selectedLanguage].weather;
      document.getElementById('ask-title').innerText = titles[selectedLanguage].ask;
      document.getElementById('image-title').innerText = titles[selectedLanguage].image;

      detectAndFetchWeather();
    }

    window.onload = () => {
      updateInterfaceLanguage();
    };

    function recordVoice() {
      if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        alert('Your browser does not support voice recognition. Please use Chrome or Edge.');
        return;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();

      // Map the selected language to proper language code
      const languageMap = {
        en: 'en-IN',
        hi: 'hi-IN',
        ml: 'ml-IN',
        ta: 'ta-IN',
        kn: 'kn-IN'
      };

      recognition.lang = languageMap[selectedLanguage] || 'en-IN';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.start();

      recognition.onstart = () => {
        console.log('Voice recognition started...');
      };

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        document.getElementById('text-query').value = transcript;
        console.log('Voice input:', transcript);
      };

      recognition.onerror = (event) => {
        alert('Voice recognition error: ' + event.error);
        console.error('Recognition error:', event);
      };

      recognition.onend = () => {
        console.log('Voice recognition ended.');
      };
    }

    async function detectAndFetchWeather() {
      const loader = document.getElementById("weather-loader");
      const output = document.getElementById("weather-output");

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async pos => {
          const coords = `${pos.coords.latitude},${pos.coords.longitude}`;
          const res = await fetch("/weather", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ location: coords })
          });
          const data = await res.json();
          loader.style.display = "none";

          if (data.error) {
            output.innerHTML = `<p style="color:red;">${data.error}</p>`;
            return;
          }

          let html = `<h3>${data.location_name}</h3>`;
          const cw = data.current_weather;
          html += `
            <ul>
              <li><b>ğŸŒ¡ Temp:</b> ${cw.temperature}Â°C (Feels like ${cw.feels_like}Â°C)</li>
              <li><b>â˜ Condition:</b> ${cw.condition}</li>
              <li><b>ğŸ’§ Humidity:</b> ${cw.humidity}%</li>
              <li><b>ğŸ’¨ Wind:</b> ${cw.wind_kph} km/h</li>
              <li><b>ğŸŒ« Visibility:</b> ${cw.visibility} km</li>
              <li><b>ğŸ”† UV Index:</b> ${cw.uv_index}</li>
              <li><b>ğŸ“… Last Updated:</b> ${cw.last_updated}</li>
            </ul>
            <h4>ğŸ“… 10-Day Forecast:</h4><div class="forecast-grid">
          `;

          data.forecast.forEach(day => {
            html += `<div class="forecast-card">
              <strong>${day.date}</strong><br>
              ${day.condition}<br>
              ğŸŒ¡ ${day.min_temp} - ${day.max_temp}Â°C<br>
              ğŸ’§ ${day.rain_chance}% rain
            </div>`;
          });

          html += "</div>";

          if (data.alerts.length > 0) {
            html += `<h4>ğŸš¨ Farming Alerts:</h4><ul>`;
            data.alerts.forEach(alert => {
              html += `<li>${alert}</li>`;
            });
            html += "</ul>";
          }

          output.innerHTML = html;
        }, err => {
          loader.style.display = "none";
          output.innerHTML = `<p style="color:red;">Location access denied. Please allow it and refresh the page.</p>`;
        });
      } else {
        loader.style.display = "none";
        output.innerHTML = `<p style="color:red;">Geolocation not supported.</p>`;
      }
    }

    async function askQuestion() {
      const query = document.getElementById("text-query").value.trim();
      const output = document.getElementById("text-answer");
      if (!query) return alert("Please type a question!");

      output.innerHTML = "Thinking...";

      const res = await fetch("/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query, language: selectedLanguage })
      });
      const data = await res.json();
      output.innerHTML = data.answer ? `<pre>${data.answer}</pre>` : `<p style="color:red;">${data.error}</p>`;
    }

    document.getElementById("plant-image").addEventListener("change", function () {
      const file = this.files[0];
      const preview = document.getElementById("preview");
      if (file) {
        preview.src = URL.createObjectURL(file);
        preview.style.display = "block";
      } else {
        preview.style.display = "none";
      }
    });

    async function getGovernmentSchemes() {
      const output = document.getElementById('schemes-output');
      output.innerHTML = "Loading government schemes...";

      const language = selectedLanguage || 'en';  // Assuming selectedLanguage is global and tracks the current language

      const res = await fetch("/government-schemes", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ language: language })
      });

      const data = await res.json();

      if (data.schemes && data.schemes.length > 0) {
        output.innerHTML = "<ul>" + data.schemes.map(scheme =>
          `<li><b>${scheme.scheme_name}</b>: ${scheme.description} <br><i>Eligibility:</i> ${scheme.eligibility} <br><a href="${scheme.more_info}" target="_blank">More Info</a></li>`
        ).join('') + "</ul>";
      } else {
        output.innerHTML = "<p style='color:red;'>No schemes found.</p>";
      }
    }

    async function getCropPrice() {
      const cropName = document.getElementById('crop-name').value.trim();
      const stateName = document.getElementById('state-name').value.trim();
      const output = document.getElementById('market-price-output');

      if (!cropName || !stateName) return alert('Please enter both crop name and state name');

      output.innerHTML = "Searching...";

      const res = await fetch("/crop-price", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ crop_name: cropName, state_name: stateName })
      });

      const data = await res.json();

      if (data.error) {
        output.innerHTML = `<p style="color:red;">${data.error}</p>`;
      } else {
        output.innerHTML = "<ul>" + data.data.map(entry =>
          `<li><b>${entry.Commodity}</b> at ${entry.Market}, ${entry.State} is â‚¹${entry.Modal_x0020_Price}</li>`).join('') + "</ul>";
      }
    }

    async function identifyPlant() {
      const fileInput = document.getElementById("plant-image");
      const output = document.getElementById("img-answer");

      if (!fileInput.files.length) return alert("Please upload a plant image");

      const formData = new FormData();
      formData.append("image", fileInput.files[0]);
      formData.append("language", selectedLanguage);

      output.innerHTML = "Analyzing image...";

      const res = await fetch("/identify", {
        method: "POST",
        body: formData
      });

      const data = await res.json();
      if (data.error) {
        output.innerHTML = `<p style="color:red;">${data.error}</p>`;
      } else if (data.disease_detected) {
        output.innerHTML = `<h4>${data.plant_name}</h4><pre>${data.treatment_advice}</pre>`;
      } else {
        output.innerHTML = `<h4>${data.plant_name}</h4><pre>${data.message}</pre>`;
      }
    }
  </script>
</body>

</html>